name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: macos-latest
    
    strategy:
      matrix:
        xcode-version: ['15.0']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode-version }}.app
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build package
        run: swift build
      
      - name: Run tests with code coverage
        run: |
          swift test --enable-code-coverage
      
      - name: Generate code coverage report
        run: |
          # Find the coverage data file
          COVERAGE_DATA=$(find .build -name "*.profdata" | head -1)
          if [ -z "$COVERAGE_DATA" ]; then
            echo "No coverage data found"
            echo "coverage=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Find the test bundle
          TEST_BUNDLE=$(find .build -name "*Tests.xctest" -type d | head -1)
          if [ -z "$TEST_BUNDLE" ]; then
            echo "No test bundle found"
            echo "coverage=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Find the executable inside the test bundle
          EXECUTABLE=$(find "$TEST_BUNDLE" -type f -perm +111 ! -name "*.swiftmodule" ! -name "*.swiftdoc" | head -1)
          if [ -z "$EXECUTABLE" ]; then
            echo "No executable found in test bundle"
            echo "coverage=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Generate coverage report using llvm-cov
          xcrun llvm-cov report \
            -instr-profile="$COVERAGE_DATA" \
            "$EXECUTABLE" \
            -ignore-filename-regex=".*Tests.*|.*Test.*" \
            > coverage.txt 2>&1 || true
          
          # Calculate percentage
          COVERAGE=$(xcrun llvm-cov report \
            -instr-profile="$COVERAGE_DATA" \
            "$EXECUTABLE" \
            -ignore-filename-regex=".*Tests.*|.*Test.*" \
            2>/dev/null | tail -1 | awk '{print $NF}' | sed 's/%//' || echo "0")
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
          cat coverage.txt || true
        id: coverage
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: .build/**/*.profdata
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
        if: always()

