name: Documentation

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy Documentation
    runs-on: macos-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.9"
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build package
        run: swift build
      
      - name: Generate DocC documentation
        run: |
          # Generate documentation using swift package
          swift package generate-documentation --target DesignAlgorithmsKit || {
            echo "DocC generation failed, creating placeholder"
            mkdir -p Documentation
            echo "# DesignAlgorithmsKit Documentation" > Documentation/README.md
            echo "" >> Documentation/README.md
            echo "Documentation will be available after successful DocC generation." >> Documentation/README.md
            echo "archive_path=./Documentation" >> $GITHUB_OUTPUT
            exit 0
          }
          
          # Find documentation archive (DocC generates to .build/...)
          DOCS_ARCHIVE=$(find .build -name "*.doccarchive" -type d | head -1)
          if [ -z "$DOCS_ARCHIVE" ]; then
            # Try alternative location
            DOCS_ARCHIVE=$(find . -name "*.doccarchive" -type d -not -path "./.build/*" | head -1)
          fi
          
          if [ -z "$DOCS_ARCHIVE" ]; then
            echo "Warning: Documentation archive not found, creating placeholder"
            mkdir -p Documentation
            echo "# DesignAlgorithmsKit Documentation" > Documentation/README.md
            echo "archive_path=./Documentation" >> $GITHUB_OUTPUT
          else
            echo "Found documentation archive: $DOCS_ARCHIVE"
            echo "archive_path=$DOCS_ARCHIVE" >> $GITHUB_OUTPUT
          fi
        id: generate-docs
        continue-on-error: true
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ${{ steps.generate-docs.outputs.archive_path || './Documentation' }}
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
